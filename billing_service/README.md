# Сервис биллинга
Сервис помогает оформлять подписки и отключать подписки на фильмы онлайн-кинотеатра.
Есть возможность оформления платежа, регистрации автоплатежа, оформление возврата (частичного и полного).

Способ отправки уведомлений об успешной оплате/возврате - электронное письмо.
Для ручной рассылки добавлена авторизация для ручки отправки events и templates для возможности отправки сообщений 
ручным способом ограниченным кругом лиц. Для возможности создания events и templates необходимо предоставить роль Manager
пользователю через Keykloak.

### Схематичная работа сервиса
Docker-compose состоит из нескольких контейнеров:
1) Контейнер billing_service (FastAPI), через который пользователь может провести первую оплату, 
сделать заявку на возврат уже сделанного платежа (если период подписки еще не завершен), 
подключить или отключить автооплату.

2) Контейнер billing_cron_service, хранящий все данные о 
платежах/подписках/возвратах;

3) Контейнер billing_cron, который отвечает за автопродление платежей.
В нем проводится поиск и передача данных о пользователях, у которых
кончается подписка через 3 дня и есть флаг автопродления.
Затем данные направляются в очередь, после которой формируется запрос на платеж в ЮKassa.


### Миграции данных
Для миграции данных используется библиотека alembic. Миграции автоматически накатываются при поднятии докер-образа.

### Таблицы данных
Для оформления подписки используется таблица Subscription со следующими полями:
id - идентификатор записи;
user_id - id пользователя, который оформил подписку;
start_date - дата начала подписки;
end_date - дата окончания подписки;
subscription_type_id - id типа подписки для связи с таблицей Subscription_Type;
payment_id - id платежа;
is_active - проверка действия подписки в данный момент;
is_repeatable - булевое значение повторения платежа для подключения автоплатежа

База данных типа подписок SubscriptionType содержит следующие поля:
id - идентификатор записи;
name - наименование типа подписки;
amount - стоимость подписки;
is_active - проверка активности данного типа подписки на текущий момент;

Для оформления платежа используется таблица Payment со следующими полями:
id - идентификатор записи;
subscription_id - идентификатор подписки для связи с таблицей;
payment_amount - списанная сумма;
payment_status - статус платежа;
payment_method_id - метод проведения платежа;
payment_date - дата проведения платежа

Для оформления полного/частичного возврата используется таблица Refund со следующими полями:
id - идентификатор записи;
payment_id - идентификатор платежа;
refund_amount - сумма возврата;
refund_status - статус возврата;
subscription_id - идентификатор подписки для связи с таблицей;
external_refund_id - идентификатор возврата;
refund_date - дата возврата

Каждое действие любой из таблиц записывается в соответствующие таблицы историй
SubscriptionHistory, SubscriptionTypeHistory, PaymentHistory, RefundHistory.
